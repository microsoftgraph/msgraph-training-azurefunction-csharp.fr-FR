---
ms.openlocfilehash: 181afe9acfe45ff619a50cf874669228b421b475
ms.sourcegitcommit: 7c550d2bcd30f505913e0cd441fbe12ae4a93b27
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/15/2021
ms.locfileid: "53445975"
---
<!-- markdownlint-disable MD002 MD041 -->

<span data-ttu-id="b21b0-101">Dans cet exercice, vous terminerez l’implémentation des fonctions Azure et mettez à jour l’application de test pour vous abonner et vous désabonner aux modifications dans la boîte de réception `SetSubscription` `Notify` d’un utilisateur.</span><span class="sxs-lookup"><span data-stu-id="b21b0-101">In this exercise you will finish implementing the Azure Functions `SetSubscription` and `Notify`, and update the test application to subscribe and unsubscribe to changes in a user's inbox.</span></span>

- <span data-ttu-id="b21b0-102">La fonction agit en tant qu’API, ce qui permet à l’application de test de créer ou de supprimer un abonnement aux modifications apportées dans la boîte de réception `SetSubscription` d’un [](https://docs.microsoft.com/graph/webhooks) utilisateur.</span><span class="sxs-lookup"><span data-stu-id="b21b0-102">The `SetSubscription` function will act as an API, allowing the test app to create or delete a [subscription](https://docs.microsoft.com/graph/webhooks) to changes in a user's inbox.</span></span>
- <span data-ttu-id="b21b0-103">La `Notify` fonction agit en tant que webhook qui reçoit les notifications de modification générées par l’abonnement.</span><span class="sxs-lookup"><span data-stu-id="b21b0-103">The `Notify` function will act as the webhook that receives change notifications generated by the subscription.</span></span>

<span data-ttu-id="b21b0-104">Les deux fonctions utiliseront le [flux](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) d’octroi d’informations d’identification client pour obtenir un jeton d’application uniquement pour appeler Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="b21b0-104">Both functions will use the [client credentials grant flow](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) to get an app-only token to call Microsoft Graph.</span></span> <span data-ttu-id="b21b0-105">Étant donné qu’un administrateur a accordé le consentement administrateur aux étendues d’autorisation requises, aucune interaction utilisateur n’est requise pour obtenir le jeton.</span><span class="sxs-lookup"><span data-stu-id="b21b0-105">Because an administrator granted admin consent to the required permission scopes, no user interaction will be required to get the token.</span></span>

## <a name="add-client-credentials-authentication-to-the-azure-functions-project"></a><span data-ttu-id="b21b0-106">Ajouter l’authentification des informations d’identification client au projet Fonctions Azure</span><span class="sxs-lookup"><span data-stu-id="b21b0-106">Add client credentials authentication to the Azure Functions project</span></span>

<span data-ttu-id="b21b0-107">Dans cette section, vous allez implémenter le flux d’informations d’identification client dans le projet Fonctions Azure pour obtenir un jeton d’accès compatible avec Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="b21b0-107">In this section you'll implement the client credentials flow in the Azure Functions project to get an access token compatible with Microsoft Graph.</span></span>

1. <span data-ttu-id="b21b0-108">Ouvrez votre CLI dans le répertoire qui contient **GraphTutorial.csproj**.</span><span class="sxs-lookup"><span data-stu-id="b21b0-108">Open your CLI in the directory that contains **GraphTutorial.csproj**.</span></span>

1. <span data-ttu-id="b21b0-109">Ajoutez votre ID d’application webhook et votre secret au magasin de secrets à l’aide des commandes suivantes.</span><span class="sxs-lookup"><span data-stu-id="b21b0-109">Add your webhook application ID and secret to the secret store using the following commands.</span></span> <span data-ttu-id="b21b0-110">Remplacez `YOUR_WEBHOOK_APP_ID_HERE` par l’ID d’application **pour Graph webhook de fonction Azure.**</span><span class="sxs-lookup"><span data-stu-id="b21b0-110">Replace `YOUR_WEBHOOK_APP_ID_HERE` with the application ID for the **Graph Azure Function Webhook**.</span></span> <span data-ttu-id="b21b0-111">Remplacez par la secret d’application que vous avez créée dans le portail `YOUR_WEBHOOK_APP_SECRET_HERE` Azure pour le Graph **webhook de fonction Azure.**</span><span class="sxs-lookup"><span data-stu-id="b21b0-111">Replace `YOUR_WEBHOOK_APP_SECRET_HERE` with the application secret you created in the Azure portal for the **Graph Azure Function Webhook**.</span></span>

    ```Shell
    dotnet user-secrets set webHookId "YOUR_WEBHOOK_APP_ID_HERE"
    dotnet user-secrets set webHookSecret "YOUR_WEBHOOK_APP_SECRET_HERE"
    ```

### <a name="create-a-client-credentials-authentication-provider"></a><span data-ttu-id="b21b0-112">Créer un fournisseur d’authentification d’informations d’identification client</span><span class="sxs-lookup"><span data-stu-id="b21b0-112">Create a client credentials authentication provider</span></span>

1. <span data-ttu-id="b21b0-113">Créez un fichier dans le répertoire **./GraphTutorial/Authentication** nommé **ClientCredentialsAuthProvider.cs** et ajoutez le code suivant.</span><span class="sxs-lookup"><span data-stu-id="b21b0-113">Create a new file in the **./GraphTutorial/Authentication** directory named **ClientCredentialsAuthProvider.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Authentication/ClientCredentialsAuthProvider.cs" id="AuthProviderSnippet":::

<span data-ttu-id="b21b0-114">Prenez le temps de réfléchir à ce que fait le code dans **ClientCredentialsAuthProvider.cs.**</span><span class="sxs-lookup"><span data-stu-id="b21b0-114">Take a moment to consider what the code in **ClientCredentialsAuthProvider.cs** does.</span></span>

- <span data-ttu-id="b21b0-115">Dans le constructeur, il initialise un **ConfidentialClientApplication** à partir du `Microsoft.Identity.Client` package.</span><span class="sxs-lookup"><span data-stu-id="b21b0-115">In the constructor, it initializes a **ConfidentialClientApplication** from the `Microsoft.Identity.Client` package.</span></span> <span data-ttu-id="b21b0-116">Il utilise les fonctions et les fonctions pour limiter l’audience de connexion uniquement à `WithAuthority(AadAuthorityAudience.AzureAdMyOrg, true)` `.WithTenantId(tenantId)` l’Microsoft 365 organisation.</span><span class="sxs-lookup"><span data-stu-id="b21b0-116">It uses the `WithAuthority(AadAuthorityAudience.AzureAdMyOrg, true)` and `.WithTenantId(tenantId)` functions to restrict the login audience to only the specified Microsoft 365 organization.</span></span>
- <span data-ttu-id="b21b0-117">Dans la `GetAccessToken` fonction, il appelle `AcquireTokenForClient` pour obtenir un jeton pour l’application.</span><span class="sxs-lookup"><span data-stu-id="b21b0-117">In the `GetAccessToken` function, it calls `AcquireTokenForClient` to get a token for the application.</span></span> <span data-ttu-id="b21b0-118">Le flux de jeton d’informations d’identification client est toujours non interactif.</span><span class="sxs-lookup"><span data-stu-id="b21b0-118">The client credentials token flow is always non-interactive.</span></span>
- <span data-ttu-id="b21b0-119">Il implémente l’interface, ce qui permet à cette classe d’être passée dans le constructeur du constructeur pour authentifier `Microsoft.Graph.IAuthenticationProvider` `GraphServiceClient` les demandes sortantes.</span><span class="sxs-lookup"><span data-stu-id="b21b0-119">It implements the `Microsoft.Graph.IAuthenticationProvider` interface, allowing this class to be passed in the constructor of the `GraphServiceClient` to authenticate outgoing requests.</span></span>

## <a name="update-graphclientservice"></a><span data-ttu-id="b21b0-120">Mettre à jour GraphClientService</span><span class="sxs-lookup"><span data-stu-id="b21b0-120">Update GraphClientService</span></span>

1. <span data-ttu-id="b21b0-121">Ouvrez **GraphClientService.cs** et ajoutez la propriété suivante à la classe.</span><span class="sxs-lookup"><span data-stu-id="b21b0-121">Open **GraphClientService.cs** and add the following property to the class.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientMembers":::

1. <span data-ttu-id="b21b0-122">Remplacez la fonction `GetAppGraphClient` existante par ce qui suit.</span><span class="sxs-lookup"><span data-stu-id="b21b0-122">Replace the existing `GetAppGraphClient` function with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientFunctions":::

## <a name="implement-notify-function"></a><span data-ttu-id="b21b0-123">Implémenter la fonction Notify</span><span class="sxs-lookup"><span data-stu-id="b21b0-123">Implement Notify function</span></span>

<span data-ttu-id="b21b0-124">Dans cette section, vous allez implémenter la fonction, qui sera utilisée comme URL de `Notify` notification pour les notifications de modification.</span><span class="sxs-lookup"><span data-stu-id="b21b0-124">In this section you'll implement the `Notify` function, which will be used as the notification URL for change notifications.</span></span>

1. <span data-ttu-id="b21b0-125">Créez un répertoire dans le **répertoire GraphTutorials** nommé **Modèles.**</span><span class="sxs-lookup"><span data-stu-id="b21b0-125">Create a new directory in the **GraphTutorials** directory named **Models**.</span></span>

1. <span data-ttu-id="b21b0-126">Créez un fichier dans le répertoire **Models** nommé **ResourceData.cs** et ajoutez le code suivant.</span><span class="sxs-lookup"><span data-stu-id="b21b0-126">Create a new file in the **Models** directory named **ResourceData.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/ResourceData.cs" id="ResourceDataSnippet":::

1. <span data-ttu-id="b21b0-127">Créez un fichier dans le répertoire **Models** nommé **ChangeNotificationPayload.cs** et ajoutez le code suivant.</span><span class="sxs-lookup"><span data-stu-id="b21b0-127">Create a new file in the **Models** directory named **ChangeNotificationPayload.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/ChangeNotificationPayload.cs" id="ChangeNotificationSnippet":::

1. <span data-ttu-id="b21b0-128">Créez un fichier dans le répertoire **Models** nommé **NotificationList.cs** et ajoutez le code suivant.</span><span class="sxs-lookup"><span data-stu-id="b21b0-128">Create a new file in the **Models** directory named **NotificationList.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/NotificationList.cs" id="NotificationListSnippet":::

1. <span data-ttu-id="b21b0-129">Ouvrez **./GraphTutorial/Notify.cs** et remplacez tout son contenu par ce qui suit.</span><span class="sxs-lookup"><span data-stu-id="b21b0-129">Open **./GraphTutorial/Notify.cs** and replace its entire contents with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Notify.cs" id="NotifySnippet":::

<span data-ttu-id="b21b0-130">Prenez le temps de réfléchir à ce que fait le code dans **Notify.cs.**</span><span class="sxs-lookup"><span data-stu-id="b21b0-130">Take a moment to consider what the code in **Notify.cs** does.</span></span>

- <span data-ttu-id="b21b0-131">La `Run` fonction vérifie la présence d’un paramètre de `validationToken` requête.</span><span class="sxs-lookup"><span data-stu-id="b21b0-131">The `Run` function checks for the presence of a `validationToken` query parameter.</span></span> <span data-ttu-id="b21b0-132">Si ce paramètre est présent, il traite la demande en tant que demande [de validation](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation)et répond en conséquence.</span><span class="sxs-lookup"><span data-stu-id="b21b0-132">If that parameter is present, it processes the request as a [validation request](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation), and responds accordingly.</span></span>
- <span data-ttu-id="b21b0-133">Si la demande n’est pas une demande de validation, la charge utile JSON est désérialisée en `ChangeNotificationCollection` une .</span><span class="sxs-lookup"><span data-stu-id="b21b0-133">If the request is not a validation request, the JSON payload is deserialized into a `ChangeNotificationCollection`.</span></span>
- <span data-ttu-id="b21b0-134">Chaque notification de la liste est vérifiée pour la valeur d’état client attendue et traitée.</span><span class="sxs-lookup"><span data-stu-id="b21b0-134">Each notification in the list is checked for the expected client state value, and is processed.</span></span>
- <span data-ttu-id="b21b0-135">Le message ayant déclenché la notification est récupéré avec Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="b21b0-135">The message that triggered the notification is retrieved with Microsoft Graph.</span></span>

## <a name="implement-setsubscription-function"></a><span data-ttu-id="b21b0-136">Implémenter la fonction SetSubscription</span><span class="sxs-lookup"><span data-stu-id="b21b0-136">Implement SetSubscription function</span></span>

<span data-ttu-id="b21b0-137">Dans cette section, vous allez implémenter la fonction SetSubscription.</span><span class="sxs-lookup"><span data-stu-id="b21b0-137">In this section, you'll implement the SetSubscription function.</span></span> <span data-ttu-id="b21b0-138">Cette fonction agit comme une API appelée par l’application de test pour créer ou supprimer un abonnement dans la boîte de réception d’un utilisateur.</span><span class="sxs-lookup"><span data-stu-id="b21b0-138">This function will act as an API that is called by the test application to create or delete a subscription on a user's inbox.</span></span>

1. <span data-ttu-id="b21b0-139">Créez un fichier dans le répertoire **Models** nommé **SetSubscriptionPayload.cs** et ajoutez le code suivant.</span><span class="sxs-lookup"><span data-stu-id="b21b0-139">Create a new file in the **Models** directory named **SetSubscriptionPayload.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/SetSubscriptionPayload.cs" id="SetSubscriptionPayloadSnippet":::

1. <span data-ttu-id="b21b0-140">Ouvrez **./GraphTutorial/SetSubscription.cs** et remplacez tout son contenu par ce qui suit.</span><span class="sxs-lookup"><span data-stu-id="b21b0-140">Open **./GraphTutorial/SetSubscription.cs** and replace its entire contents with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/SetSubscription.cs" id="SetSubscriptionSnippet":::

<span data-ttu-id="b21b0-141">Prenez le temps de réfléchir à ce que fait le code **dans SetSubscription.cs.**</span><span class="sxs-lookup"><span data-stu-id="b21b0-141">Take a moment to consider what the code in **SetSubscription.cs** does.</span></span>

- <span data-ttu-id="b21b0-142">La fonction lit la charge utile JSON envoyée dans la requête POST pour déterminer le type de demande (s’abonner ou se désabonner), l’ID d’utilisateur pour s’abonner et l’ID d’abonnement à `Run` désabonner.</span><span class="sxs-lookup"><span data-stu-id="b21b0-142">The `Run` function reads the JSON payload sent in the POST request to determine the request type (subscribe or unsubscribe), the user ID to subscribe for, and the subscription ID to unsubscribe.</span></span>
- <span data-ttu-id="b21b0-143">Si la demande est une demande d’abonnement, elle utilise le SDK Microsoft Graph pour créer un abonnement dans la boîte de réception de l’utilisateur spécifié.</span><span class="sxs-lookup"><span data-stu-id="b21b0-143">If the request is a subscribe request, it uses the Microsoft Graph SDK to create a new subscription in the specified user's inbox.</span></span> <span data-ttu-id="b21b0-144">L’abonnement notifiera la création ou la mise à jour des messages.</span><span class="sxs-lookup"><span data-stu-id="b21b0-144">The subscription will notify when messages are created or updated.</span></span> <span data-ttu-id="b21b0-145">Le nouvel abonnement est renvoyé dans la charge utile JSON de la réponse.</span><span class="sxs-lookup"><span data-stu-id="b21b0-145">The new subscription is returned in the JSON payload of the response.</span></span>
- <span data-ttu-id="b21b0-146">Si la demande est une demande de désabonnement, elle utilise le SDK Microsoft Graph pour supprimer l’abonnement spécifié.</span><span class="sxs-lookup"><span data-stu-id="b21b0-146">If the request is an unsubscribe request, it uses the Microsoft Graph SDK to delete the specified subscription.</span></span>

## <a name="call-setsubscription-from-the-test-app"></a><span data-ttu-id="b21b0-147">Appeler SetSubscription à partir de l’application de test</span><span class="sxs-lookup"><span data-stu-id="b21b0-147">Call SetSubscription from the test app</span></span>

<span data-ttu-id="b21b0-148">Dans cette section, vous allez implémenter des fonctions pour créer et supprimer des abonnements dans l’application de test.</span><span class="sxs-lookup"><span data-stu-id="b21b0-148">In this section, you'll implement functions to create and delete subscriptions in the test app.</span></span>

1. <span data-ttu-id="b21b0-149">Ouvrez **./TestClient/azurefunctions.js** et ajoutez la fonction suivante.</span><span class="sxs-lookup"><span data-stu-id="b21b0-149">Open **./TestClient/azurefunctions.js** and add the following function.</span></span>

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="createSubscriptionSnippet":::

    <span data-ttu-id="b21b0-150">Ce code appelle la fonction Azure pour s’abonner et ajoute le nouvel abonnement au `SetSubscription` tableau des abonnements dans la session.</span><span class="sxs-lookup"><span data-stu-id="b21b0-150">This code calls the `SetSubscription` Azure Function to subscribe and adds the new subscription to the array of subscriptions in the session.</span></span>

1. <span data-ttu-id="b21b0-151">Ajoutez la fonction suivante à **azurefunctions.js**.</span><span class="sxs-lookup"><span data-stu-id="b21b0-151">Add the following function to **azurefunctions.js**.</span></span>

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="deleteSubscriptionSnippet":::

    <span data-ttu-id="b21b0-152">Ce code appelle la fonction Azure pour se désabonner et supprime l’abonnement du tableau des `SetSubscription` abonnements dans la session.</span><span class="sxs-lookup"><span data-stu-id="b21b0-152">This code calls the `SetSubscription` Azure Function to unsubscribe and removes the subscription from the array of subscriptions in the session.</span></span>

1. <span data-ttu-id="b21b0-153">Si ngrok n’est pas en cours d’exécution, exécutez ngrok ( ) et copiez l’URL de `ngrok http 7071` forwarding HTTPS.</span><span class="sxs-lookup"><span data-stu-id="b21b0-153">If you do not have ngrok running, run ngrok (`ngrok http 7071`) and copy the HTTPS forwarding URL.</span></span>

1. <span data-ttu-id="b21b0-154">Ajoutez l’URL ngrok au magasin de secrets utilisateur en exécutant la commande suivante.</span><span class="sxs-lookup"><span data-stu-id="b21b0-154">Add the ngrok URL to the user secrets store by running the following command.</span></span>

    ```Shell
    dotnet user-secrets set ngrokUrl "YOUR_NGROK_URL_HERE"
    ```

    > [!IMPORTANT]
    > <span data-ttu-id="b21b0-155">Si vous redémarrez ngrok, vous devrez répéter cette commande pour mettre à jour votre URL ngrok.</span><span class="sxs-lookup"><span data-stu-id="b21b0-155">If you restart ngrok, you will need to repeat this command to update your ngrok URL.</span></span>

1. <span data-ttu-id="b21b0-156">Modifiez le répertoire actuel de votre CLI en **répertoire ./GraphTutorial** et exécutez la commande suivante pour démarrer la fonction Azure localement.</span><span class="sxs-lookup"><span data-stu-id="b21b0-156">Change the current directory in your CLI to the **./GraphTutorial** directory and run the following command to start the Azure Function locally.</span></span>

    ```Shell
    func start
    ```

1. <span data-ttu-id="b21b0-157">Actualisez la SPA et sélectionnez **l’élément de navigation Abonnements.**</span><span class="sxs-lookup"><span data-stu-id="b21b0-157">Refresh the SPA and select the **Subscriptions** nav item.</span></span> <span data-ttu-id="b21b0-158">Entrez un ID d’utilisateur pour un utilisateur de votre organisation Microsoft 365 qui dispose d’une boîte aux lettres Exchange Online’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="b21b0-158">Enter a user ID for a user in your Microsoft 365 organization that has an Exchange Online mailbox.</span></span> <span data-ttu-id="b21b0-159">Il peut s’agit de l’utilisateur `id` (de Microsoft Graph) ou de l’utilisateur. `userPrincipalName`</span><span class="sxs-lookup"><span data-stu-id="b21b0-159">This can either be the user's `id` (from Microsoft Graph) or the user's `userPrincipalName`.</span></span> <span data-ttu-id="b21b0-160">Cliquez sur **S’abonner.**</span><span class="sxs-lookup"><span data-stu-id="b21b0-160">Click **Subscribe**.</span></span>

1. <span data-ttu-id="b21b0-161">La page s’actualise en affichant le nouvel abonnement dans le tableau.</span><span class="sxs-lookup"><span data-stu-id="b21b0-161">The page refreshes showing the new subscription in the table.</span></span>

1. <span data-ttu-id="b21b0-162">Envoyez un courrier électronique à l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="b21b0-162">Send an email to the user.</span></span> <span data-ttu-id="b21b0-163">Après un court instant, la `Notify` fonction doit être appelée.</span><span class="sxs-lookup"><span data-stu-id="b21b0-163">After a brief time, the `Notify` function should be called.</span></span> <span data-ttu-id="b21b0-164">Vous pouvez le vérifier dans l’interface web ngrok ( ) ou dans la sortie `http://localhost:4040` de débogage du projet de fonction Azure.</span><span class="sxs-lookup"><span data-stu-id="b21b0-164">You can verify this in the ngrok web interface (`http://localhost:4040`) or in the debug output of the Azure Function project.</span></span>

    ```Shell
    ...
    [7/8/2020 7:33:57 PM] The following message was created:
    [7/8/2020 7:33:57 PM] Subject: Hi Megan!, ID: AAMkAGUyN2I4N2RlLTEzMTAtNDBmYy1hODdlLTY2NTQwODE2MGEwZgBGAAAAAAA2J9QH-DvMRK3pBt_8rA6nBwCuPIFjbMEkToHcVnQirM5qAAAAAAEMAACuPIFjbMEkToHcVnQirM5qAACHmpAsAAA=
    [7/8/2020 7:33:57 PM] Executed 'Notify' (Succeeded, Id=9c40af0b-e082-4418-aa3a-aee624f30e7a)
    ...
    ```

1. <span data-ttu-id="b21b0-165">Dans l’application de test, cliquez **sur Supprimer** dans la ligne de tableau de l’abonnement.</span><span class="sxs-lookup"><span data-stu-id="b21b0-165">In the test app, click **Delete** in the table row for the subscription.</span></span> <span data-ttu-id="b21b0-166">La page est actualisée et l’abonnement n’est plus dans le tableau.</span><span class="sxs-lookup"><span data-stu-id="b21b0-166">The page refreshes and the subscription is no longer in the table.</span></span>
